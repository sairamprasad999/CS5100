<html>
<head>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://code.jquery.com/jquery.min.js"></script>
<style>

body { font-family: "Lato"; }


#chart {
  margin-left: 40px;
  height: 510px;
}


.axis path, .axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}


</style>
</head>
<body>
<div id="chart"></div>
<select id="selectWeather">
<option>Precipitation</option>
<option>MaxWind</option>
<option>SnowInches</option>
</select>
<script>
var allFlights;
var selectedFlights = [];
//var selectedWeather = [];
var sourceCity = "ATL";
var destCity = "LAX";
var startMon = 0;
var endMon = 11;
var selectedWeather = "Precipitation";


var margin = {top: 22.5, right: 19.5, bottom: 30.5, left: 39.5},
    width = 960 - margin.right,
    height = 500 - margin.top - margin.bottom,
    padding = 30;

var city_airport_map = {};

d3.json("data1.json", function (error, data){
	allFlights = data;
	console.log(allFlights[0].ATL);
	for(var i = 0; i< allFlights.length; i++){
		city_airport_map[Object.getOwnPropertyNames(allFlights[i])[0]] = i;
	};
	function getSelectedData(){
		function isSelected(flight){
			return flight.to == destCity;
		}

		for(var i = startMon; i <= endMon; i++){
		  //selected Month
		  //console.log(allFlights[city_airport_map[sourceCity]].sourceCity[i].flights);
			for(var j = 0; j< allFlights[city_airport_map[sourceCity]][sourceCity][i].length; j++){ // all days
					var temp_data = allFlights[city_airport_map[sourceCity]][sourceCity][i][j].flights.filter(isSelected);
					for(var k = 0; k< temp_data.length; k++){
						temp_data[k].weather = allFlights[city_airport_map[sourceCity]][sourceCity][i][j].weather;
					}
					selectedFlights = selectedFlights.concat(temp_data);
			}
		}
	}
	getSelectedData();	

	var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  	.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var xDomain = [];  
	var	yDomain = [];
	var xScale = d3.scale.linear().domain(xDomain).range([0, width]),
	    yScale = d3.scale.linear().domain(yDomain).range([height, 0]);

	// The x & y axes.
	var xAxis = d3.svg.axis().orient("bottom").scale(xScale),
	//.ticks(12, d3.format(",d")),
	    yAxis = d3.svg.axis().scale(yScale).orient("left");

	// Add the x-axis.
	var xAxisValue = svg.append("g")
	    .attr("class", "axis")
	    .attr("transform", "translate(0," + height + ")")
	    .call(xAxis);

	// Add the y-axis.
	var yAxisValue = svg.append("g")
	    .attr("class", "axis")
	    .call(yAxis);  

	var xlabelRegression = svg.append("text")
    	.attr("class", "x label")
    	.attr("text-anchor", "end")
    	.attr("x", width)
    	.attr("y", height - 6)
    	.text("Delay Time(minutes)");

    var ylabelRegression = svg.append("text")
    	.attr("class", "y label")
    	.attr("text-anchor", "end")
    	.attr("x", 6)
    	.attr("y", 6)
    	.attr("dy", ".75em")
        .attr("transform", "rotate(-90)")
    	.text(function(){
    		if(selectedWeather == "MaxWind"){
    			return "Wind Speed(miles/hour)";
    	} else if(selectedWeather == "Precipitation"){
    			return "Precipitation(inches)"
    	} else if(selectedWeather == "SnowInches"){
    			return "Snow(inches)"	
    	}
    	});

	 drawRegression();

	 $(document).ready(function(){ // ran when the document is fully loaded
	  // retrieve the jQuery wrapped dom object identified by the selector '#selectOccupation'
	  var sel = $('#selectWeather');
	  // assign a change listener to it
	  sel.change(function(){ //inside the listener
	    // retrieve the value of the object firing the event (referenced by this)
	    selectedWeather = $(this).val();
	    drawRegression();

	  });
	});
    function drawRegression(){
    	svg.selectAll("circle").remove();
    	svg.selectAll("line").remove();
    	var selectedWeatherFlights;
    	if(selectedWeather == "MaxWind"){
    		selectedWeatherFlights = selectedFlights.filter(function(d){
    			return d.weather.Precipitation == "0" &&
    			d.weather.SnowInches == "0";
    		});
    	} else if(selectedWeather == "Precipitation"){
    		selectedWeatherFlights = selectedFlights.filter(function(d){
    			return d.weather.Precipitation != "0" &&
    			d.weather.SnowInches == "0";
    		});
    	} else if(selectedWeather == "SnowInches"){
    		selectedWeatherFlights = selectedFlights.filter(function(d){
    			return d.weather.SnowInches != "0";
    		});
    	}

    	xDomain = [0,d3.max(selectedWeatherFlights, function(d){return Number(d.WeatherDelay)})];  
		yDomain = [d3.min(selectedWeatherFlights, function(d){return Number(d.weather[selectedWeather])}),d3.max(selectedWeatherFlights, function(d){return Number(d.weather[selectedWeather])})];
		xScale = d3.scale.linear().domain(xDomain).range([0, width]),
	    yScale = d3.scale.linear().domain(yDomain).range([height, 0]);

	// The x & y axes.
		xAxis = d3.svg.axis().orient("bottom").scale(xScale),
	//.ticks(12, d3.format(",d")),
	    yAxis = d3.svg.axis().scale(yScale).orient("left");

	    xAxisValue.call(xAxis);
	    yAxisValue.call(yAxis);

	    ylabelRegression.text(function(){
    		if(selectedWeather == "MaxWind"){
    			return "Wind Speed(miles/hour)";
    	} else if(selectedWeather == "Precipitation"){
    			return "Precipitation(inches)"
    	} else if(selectedWeather == "SnowInches"){
    			return "Snow(inches)"	
    	}
    	});


	    

	    var selectedPoints = selectedWeatherFlights.map(function(d){
	    	return {x : Number(d.WeatherDelay),
	    			y : Number(d.weather[selectedWeather])
	    			};
	    })

	    function getModel (activePoints) {	
			var model = {};
			var meanX = d3.mean(activePoints, function (d) { 
				return d.x;
			});
			var meanY = d3.mean(activePoints, function (d) { 
				return d.y;
			});
			model.slope = d3.sum(activePoints, function (d) {
				return (d.x - meanX) * (d.y - meanY);
			});
			model.slope /= d3.sum(activePoints, function (d) {
				return (d.x - meanX) * (d.x - meanX);
			});
			model.intercept = meanY - model.slope * meanX;
			
			return model;
		}

		//draw all circles
		circles = svg.selectAll("circle").data(selectedPoints).enter()
			.append("circle")
			.attr("cx", function (d) { return xScale(d.x); })
			.attr("cy", function (d) { return yScale(d.y); })
			.attr("r", 3)
			.style("opacity", 0.8 )
			.style("fill", "#99f" );

		//draw regressionline
		var model = getModel(selectedPoints);
			regressionLine = svg.append("line")
			.attr("x1", xScale(xDomain[0]))
			.attr("y1", yScale(model.slope * xDomain[0] + model.intercept))
			.attr("x2", xScale(xDomain[1]))
			.attr("y2", yScale(model.slope * xDomain[1] + model.intercept))
			.style("stroke", "#0000FF")
			.style("opacity", 0.3);
	}

});
</script>
</body>
</html>